# =============================================================================
# ZTA Multi-Agent Testbed - With mTLS (Mutual TLS)
# =============================================================================
# All inter-service communication is encrypted and authenticated via mTLS.
# 
# Certificate Chain:
#   Root CA → Service Certificates → Mutual Authentication
#
# Traffic Flow (mTLS):
#   User (HTTP) → Travel Planner Envoy → Travel Planner
#                       ↓ (mTLS)
#                 Agent Envoy → Agent
#                       ↓ (mTLS)
#                 MCP Envoy → MCP → Service
# =============================================================================

services:
  # ===========================================================================
  # OPA - Policy Decision Point
  # ===========================================================================
  
  opa:
    image: openpolicyagent/opa:latest
    container_name: zta-opa
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
      - "/policies/policy.rego"
    volumes:
      - ./zta-infrastructure/opa:/policies:ro
    ports:
      - "8181:8181"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - zta-network

  # ===========================================================================
  # Backend Services
  # ===========================================================================
  
  airline-service:
    build:
      context: ./services/airline
      dockerfile: Dockerfile
    container_name: zta-airline-service
    environment:
      - PORT=8001
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - zta-network

  hotel-service:
    build:
      context: ./services/hotel
      dockerfile: Dockerfile
    container_name: zta-hotel-service
    environment:
      - PORT=8002
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - zta-network

  car-rental-service:
    build:
      context: ./services/car-rental
      dockerfile: Dockerfile
    container_name: zta-car-rental-service
    environment:
      - PORT=8003
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - zta-network

  itinerary-service:
    build:
      context: ./services/itinerary
      dockerfile: Dockerfile
    container_name: zta-itinerary-service
    environment:
      - PORT=8084
      - DATABASE_URL=sqlite:///./itinerary.db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - zta-network

  # ===========================================================================
  # MCP Servers with mTLS Envoy Sidecars
  # ===========================================================================
  
  airline-mcp:
    build:
      context: ./mcp-servers/airline
      dockerfile: Dockerfile
    container_name: zta-airline-mcp
    environment:
      - PORT=8010
      - AIRLINE_SERVICE_URL=http://airline-service:8001
    depends_on:
      airline-service:
        condition: service_healthy
    networks:
      - zta-network

  airline-mcp-envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: zta-airline-mcp-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./zta-infrastructure/envoy/envoy-airline-mcp-mtls.yaml:/etc/envoy/envoy.yaml:ro
      - ./zta-infrastructure/certs:/etc/envoy/certs:ro
    ports:
      - "18010:10000"
      - "19010:9901"
    depends_on:
      - airline-mcp
      - opa
    networks:
      - zta-network

  hotel-mcp:
    build:
      context: ./mcp-servers/hotel
      dockerfile: Dockerfile
    container_name: zta-hotel-mcp
    environment:
      - PORT=8011
      - HOTEL_SERVICE_URL=http://hotel-service:8002
    depends_on:
      hotel-service:
        condition: service_healthy
    networks:
      - zta-network

  hotel-mcp-envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: zta-hotel-mcp-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./zta-infrastructure/envoy/envoy-hotel-mcp-mtls.yaml:/etc/envoy/envoy.yaml:ro
      - ./zta-infrastructure/certs:/etc/envoy/certs:ro
    ports:
      - "18011:10000"
      - "19011:9901"
    depends_on:
      - hotel-mcp
      - opa
    networks:
      - zta-network

  car-rental-mcp:
    build:
      context: ./mcp-servers/car-rental
      dockerfile: Dockerfile
    container_name: zta-car-rental-mcp
    environment:
      - PORT=8012
      - CAR_RENTAL_SERVICE_URL=http://car-rental-service:8003
    depends_on:
      car-rental-service:
        condition: service_healthy
    networks:
      - zta-network

  car-rental-mcp-envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: zta-car-rental-mcp-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./zta-infrastructure/envoy/envoy-car-rental-mcp-mtls.yaml:/etc/envoy/envoy.yaml:ro
      - ./zta-infrastructure/certs:/etc/envoy/certs:ro
    ports:
      - "18012:10000"
      - "19012:9901"
    depends_on:
      - car-rental-mcp
      - opa
    networks:
      - zta-network

  # ===========================================================================
  # Worker Agents with mTLS Envoy Sidecars
  # ===========================================================================
  
  airline-agent:
    build:
      context: ./agents/airline-agent
      dockerfile: Dockerfile
    container_name: zta-airline-agent
    environment:
      - PORT=8091
      # Agent calls MCP via mTLS
      - AIRLINE_MCP_URL=https://airline-mcp-envoy:10000
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      # mTLS certificates
      - CA_CERT_PATH=/etc/certs/ca-cert.pem
      - CLIENT_CERT_PATH=/etc/certs/airline-agent-cert.pem
      - CLIENT_KEY_PATH=/etc/certs/airline-agent-key.pem
    volumes:
      - ./zta-infrastructure/certs:/etc/certs:ro
    depends_on:
      - airline-mcp-envoy
    networks:
      - zta-network

  airline-agent-envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: zta-airline-agent-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./zta-infrastructure/envoy/envoy-airline-agent-mtls.yaml:/etc/envoy/envoy.yaml:ro
      - ./zta-infrastructure/certs:/etc/envoy/certs:ro
    ports:
      - "18091:10000"
      - "19091:9901"
    depends_on:
      - airline-agent
      - opa
    networks:
      - zta-network

  hotel-agent:
    build:
      context: ./agents/hotel-agent
      dockerfile: Dockerfile
    container_name: zta-hotel-agent
    environment:
      - PORT=8092
      - HOTEL_MCP_URL=https://hotel-mcp-envoy:10000
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      # mTLS certificates
      - CA_CERT_PATH=/etc/certs/ca-cert.pem
      - CLIENT_CERT_PATH=/etc/certs/hotel-agent-cert.pem
      - CLIENT_KEY_PATH=/etc/certs/hotel-agent-key.pem
    volumes:
      - ./zta-infrastructure/certs:/etc/certs:ro
    depends_on:
      - hotel-mcp-envoy
    networks:
      - zta-network

  hotel-agent-envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: zta-hotel-agent-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./zta-infrastructure/envoy/envoy-hotel-agent-mtls.yaml:/etc/envoy/envoy.yaml:ro
      - ./zta-infrastructure/certs:/etc/envoy/certs:ro
    ports:
      - "18092:10000"
      - "19092:9901"
    depends_on:
      - hotel-agent
      - opa
    networks:
      - zta-network

  car-rental-agent:
    build:
      context: ./agents/car-rental-agent
      dockerfile: Dockerfile
    container_name: zta-car-rental-agent
    environment:
      - PORT=8093
      - CAR_RENTAL_MCP_URL=https://car-rental-mcp-envoy:10000
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      # mTLS certificates
      - CA_CERT_PATH=/etc/certs/ca-cert.pem
      - CLIENT_CERT_PATH=/etc/certs/car-rental-agent-cert.pem
      - CLIENT_KEY_PATH=/etc/certs/car-rental-agent-key.pem
    volumes:
      - ./zta-infrastructure/certs:/etc/certs:ro
    depends_on:
      - car-rental-mcp-envoy
    networks:
      - zta-network

  car-rental-agent-envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: zta-car-rental-agent-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./zta-infrastructure/envoy/envoy-car-rental-agent-mtls.yaml:/etc/envoy/envoy.yaml:ro
      - ./zta-infrastructure/certs:/etc/envoy/certs:ro
    ports:
      - "18093:10000"
      - "19093:9901"
    depends_on:
      - car-rental-agent
      - opa
    networks:
      - zta-network

  # ===========================================================================
  # Travel Planner with mTLS Envoy Sidecar
  # ===========================================================================
  
  travel-planner:
    build:
      context: ./agents/travel-planner
      dockerfile: Dockerfile
    container_name: zta-travel-planner
    environment:
      - PORT=8080
      - PLANNER_ID=travel-planner
      - PLANNER_NAME=Travel Planner
      # Point to agents via their Envoy sidecars (HTTP internally, mTLS between Envoys)
      - AIRLINE_AGENT_URL=http://airline-agent-envoy:10000
      - HOTEL_AGENT_URL=http://hotel-agent-envoy:10000
      - CAR_RENTAL_AGENT_URL=http://car-rental-agent-envoy:10000
      - ITINERARY_SERVICE_URL=http://itinerary-service:8084
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-zta-testbed}
      # mTLS certificates for outbound calls
      - CA_CERT_PATH=/etc/certs/ca-cert.pem
      - CLIENT_CERT_PATH=/etc/certs/travel-planner-cert.pem
      - CLIENT_KEY_PATH=/etc/certs/travel-planner-key.pem
    volumes:
      - ./zta-infrastructure/certs:/etc/certs:ro
    depends_on:
      itinerary-service:
        condition: service_healthy
      airline-agent-envoy:
        condition: service_started
      hotel-agent-envoy:
        condition: service_started
      car-rental-agent-envoy:
        condition: service_started
    networks:
      - zta-network

  travel-planner-envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: zta-travel-planner-envoy
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]
    volumes:
      - ./zta-infrastructure/envoy/envoy-travel-planner-mtls.yaml:/etc/envoy/envoy.yaml:ro
      - ./zta-infrastructure/certs:/etc/envoy/certs:ro
    ports:
      - "8080:10000"    # Main entry point (plain HTTP for users)
      - "19080:9901"    # Envoy admin
    depends_on:
      - travel-planner
      - opa
    networks:
      - zta-network

networks:
  zta-network:
    driver: bridge
