version: '3.8'

services:
  # =============================================================================
  # Backend Services (FastAPI + SQLite)
  # =============================================================================
  
  airline-service:
    build:
      context: ./services/airline
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      - PORT=8001
      - OTEL_SERVICE_NAME=airline-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - zta-network

  hotel-service:
    build:
      context: ./services/hotel
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
    environment:
      - PORT=8002
      - OTEL_SERVICE_NAME=hotel-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - zta-network

  car-rental-service:
    build:
      context: ./services/car-rental
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - PORT=8003
      - OTEL_SERVICE_NAME=car-rental-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - zta-network

  # =============================================================================
  # MCP Servers (FastMCP with HTTP transport)
  # =============================================================================
  
  airline-mcp:
    build:
      context: ./mcp-servers/airline
      dockerfile: Dockerfile
    ports:
      - "8010:8010"
    environment:
      - PORT=8010
      - AIRLINE_SERVICE_URL=http://airline-service:8001
      - OTEL_SERVICE_NAME=airline-mcp
      - FASTMCP_ALLOWED_HOSTS=*
    depends_on:
      airline-service:
        condition: service_healthy
    networks:
      - zta-network

  hotel-mcp:
    build:
      context: ./mcp-servers/hotel
      dockerfile: Dockerfile
    ports:
      - "8011:8011"
    environment:
      - PORT=8011
      - HOTEL_SERVICE_URL=http://hotel-service:8002
      - OTEL_SERVICE_NAME=hotel-mcp
      - FASTMCP_ALLOWED_HOSTS=*
    depends_on:
      hotel-service:
        condition: service_healthy
    networks:
      - zta-network

  car-rental-mcp:
    build:
      context: ./mcp-servers/car-rental
      dockerfile: Dockerfile
    ports:
      - "8012:8012"
    environment:
      - PORT=8012
      - CAR_RENTAL_SERVICE_URL=http://car-rental-service:8003
      - OTEL_SERVICE_NAME=car-rental-mcp
      - FASTMCP_ALLOWED_HOSTS=*
    depends_on:
      car-rental-service:
        condition: service_healthy
    networks:
      - zta-network

  # =============================================================================
  # Supervisor Agent (orchestrates worker agents)
  # =============================================================================
  
  travel-supervisor:
    build:
      context: ./agents/travel-supervisor
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - MCP_TRANSPORT=http
      - AIRLINE_MCP_URL=http://airline-mcp:8010
      - HOTEL_MCP_URL=http://hotel-mcp:8011
      - CAR_RENTAL_MCP_URL=http://car-rental-mcp:8012
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-zta-testbed}
      - OTEL_SERVICE_NAME=travel-supervisor
    depends_on:
      - airline-mcp
      - hotel-mcp
      - car-rental-mcp
    networks:
      - zta-network

networks:
  zta-network:
    driver: bridge
